<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title></title><link rel="stylesheet" href="style_cache/github-dfc6417658d5b6b7dd3d1e58c09c2c25dee7506e.css" />
  <link rel="stylesheet" href="style_cache/github2-b564d9e99bd5747d2d0901c61c403e758a5e5ef1.css" />
  <style>
    .file-box {
      margin: 64px auto;
      width: 920px;
    }
	body {
		font-size: 14px;
		line-height: 22px;
		<!--font-family: "adelle",Georgia,"Times New Roman",serif;-->
		color: #4e443c;
		background: #f0efe7;
	}

	.book-toc {

	}
	a {
		color: #0388a6;
		text-decoration: none;
	}
	a:hover {
		color: #04b1d8;
		text-decoration: none;
	}
	ol.book-toc li.chapter{
		margin-bottom:0.6em
	}
	ol.book-toc, ol{
		list-style-type: disc
	}
	ol.book-toc{
		margin:30px 36px
	}
	ol.book-toc a{
		padding-left:4px
	}
	li {
		line-height: 22px;
	}
	h1, h2, h3, h4, h5, h6, li, p, a, ol, div{
		margin: 0;
		padding: 0;
		border: 0;
		vertical-align: baseline;
	}
	ul, ol {
		padding: 0;
		margin: 0 0 11px 25px;
	}
	h1 {
		font-size: 36px;
		line-height: 44px;
		margin-bottom: 0.4em;
	}
	h2 {
		font-size: 18px;
		color: #f14e32;
		font-weight: bold;
	}
	h3, h4, h5, h6 {
		font-size: 14px;
		color: #f14e32;
		font-weight: bold;
	}
	ol.book-toc h1{
		font-size: 22px;
		line-height: 44px;
		margin-bottom: 0.4em;
	}
	ol.book-toc h2 {
		font-size: 16px;
		color: #f14e32;
		font-weight: bold;
	}
	ol.book-toc h3, h4, h5, h6 {
		font-size: 14px;
		color: #f14e32;
		font-weight: bold;
	}
	p {
		margin: 0 0 11px;
		font-size: 14px;
		line-height: 22px;
	}
	div {
		display: block;
	}
	div#nav{
		padding: 30px
	}
  </style>
</head>
<body>
  <div class="page">
    <div class="file-box">
	<div class="file">
		<div id="readme" class="blob instapaper_body announce md">
		  <article class="markdown-body entry-content" itemprop="mainContentOfPage">
			<html>
 <body>
  <h1>
   <a class="anchor" href="#%E7%AC%AC%E4%B8%89%E5%8D%81%E7%AB%A0%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E6%8D%A2%E6%88%90%E6%95%B4%E6%95%B0" name="user-content-%E7%AC%AC%E4%B8%89%E5%8D%81%E7%AB%A0%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E6%8D%A2%E6%88%90%E6%95%B4%E6%95%B0">
    <span class="octicon octicon-link">
    </span>
   </a>
   第三十章：字符串转换成整数
  </h1>
  <h2>
   <a class="anchor" href="#%E9%A2%98%E7%9B%AE%E6%8F%8F%E8%BF%B0" name="user-content-%E9%A2%98%E7%9B%AE%E6%8F%8F%E8%BF%B0">
    <span class="octicon octicon-link">
    </span>
   </a>
   题目描述
  </h2>
  <p>
   输入一个表示整数的字符串，把该字符串转换成整数并输出，例如输入字符串"345"，则输出整数345。
  </p>
  <p>
   给定函数原型
   <code>
    int StrToInt(const char *str)
   </code>
   ，完成函数StrToInt，实现字符串转换成整数的功能，不得用库函数atoi（即便准许使用，其对于溢出情况的处理也达不到题目的要求，详情请参看下文第7节末）。
  </p>
  <h2>
   <a class="anchor" href="#%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E6%B3%95" name="user-content-%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E6%B3%95">
    <span class="octicon octicon-link">
    </span>
   </a>
   分析与解法
  </h2>
  <p>
   我们来一步一步分析（共9小节，重点在下文第8小节及后续内容），直至写出第一份准确的代码：
  </p>
  <p>
   <em>
    <strong>
     1
    </strong>
   </em>
   . 本题考查的实际上就是字符串转换成整数的问题，或者说是要你自行实现atoi函数。那如何实现把表示整数的字符串正确地转换成整数呢？以"345"作为例子：
  </p>
  <ol>
   <li>
    当我们扫描到字符串的第一个字符'3'时，由于我们知道这是第一位，所以得到数字3。
    <br/>
   </li>
   <li>
    当扫描到第二个数字'4'时，而之前我们知道前面有一个3，所以便在后面加上一个数字4，那前面的3相当于30，因此得到数字：3*10+4=34。
    <br/>
   </li>
   <li>
    继续扫描到字符'5'，'5'的前面已经有了34，由于前面的34相当于340，加上后面扫描到的5，最终得到的数是：34*10+5=345。
    <br/>
    因此，此题的思路便是：每扫描到一个字符，我们便把在之前得到的数字乘以10，然后再加上当前字符表示的数字。
    <br/>
   </li>
  </ol>
  <p>
   <em>
    <strong>
     2
    </strong>
   </em>
   . 思路有了，有一些细节需要注意，如zhedahht所说：
  </p>
  <ol>
   <li>
    “由于整数可能不仅仅之含有数字，还有可能以'+'或者'-'开头，表示整数的正负。因此我们需要把这个字符串的第一个字符做特殊处理。如果第一个字符是'+'号，则不需要做任何操作；如果第一个字符是'-'号，则表明这个整数是个负数，在最后的时候我们要把得到的数值变成负数。
    <br/>
   </li>
   <li>
    接着我们试着处理非法输入。由于输入的是指针，在使用指针之前，我们要做的第一件是判断这个指针是不是为空。如果试着去访问空指针，将不可避免地导致程序崩溃。
    <br/>
   </li>
   <li>
    另外，输入的字符串中可能含有不是数字的字符。每当碰到这些非法的字符，我们就没有必要再继续转换。
    <br/>
   </li>
   <li>
    最后一个需要考虑的问题是溢出问题。由于输入的数字是以字符串的形式输入，因此有可能输入一个很大的数字转换之后会超过能够表示的最大的整数而溢出。”
    <br/>
   </li>
  </ol>
  <p>
   比如，当给的字符串是如左边图片所示的时候，有考虑到么？当然，它们各自对应的正确输出如右边图片所示（假定你是在32位系统下，且编译环境是VS2008以上）：
  </p>
  <p>
   <a href="../images/30%7E31/30.1.jpg" target="_blank">
    <img alt="" src="../images/30%7E31/30.1.jpg" style="max-width:100%;"/>
   </a>
  </p>
  <p>
   <em>
    <strong>
     3
    </strong>
   </em>
   . 很快，可能你就会写下如下代码：
  </p>
  <div class="highlight highlight-cpp">
   <pre><span class="c1">//copyright@zhedahht 2007</span>
<span class="k">enum</span> <span class="n">Status</span> <span class="p">{</span><span class="n">kValid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kInvalid</span><span class="p">};</span>
<span class="kt">int</span> <span class="n">g_nStatus</span> <span class="o">=</span> <span class="n">kValid</span><span class="p">;</span>

<span class="c1">// Convert a string into an integer</span>
<span class="kt">int</span> <span class="nf">StrToInt</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">g_nStatus</span> <span class="o">=</span> <span class="n">kInvalid</span><span class="p">;</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">digit</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>

        <span class="c1">// the first char in the string can be '+' or '-'</span>
        <span class="kt">bool</span> <span class="n">minus</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">digit</span> <span class="o">==</span> <span class="sc">'+'</span><span class="p">)</span>
            <span class="n">digit</span> <span class="o">++</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">digit</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">digit</span> <span class="o">++</span><span class="p">;</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// the remaining chars in the string</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">digit</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">digit</span> <span class="o">&gt;=</span> <span class="sc">'0'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">digit</span> <span class="o">&lt;=</span> <span class="sc">'9'</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">num</span> <span class="o">=</span> <span class="n">num</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">digit</span> <span class="o">-</span> <span class="sc">'0'</span><span class="p">);</span>

                <span class="c1">// overflow</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">())</span>
                <span class="p">{</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">digit</span> <span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// if the char is not a digit, invalid input</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">digit</span> <span class="o">==</span> <span class="sc">'\0'</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">g_nStatus</span> <span class="o">=</span> <span class="n">kValid</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">minus</span><span class="p">)</span>
                <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">num</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">num</span><span class="p">);</span>
<span class="p">}</span>
</pre>
  </div>
  <p>
   run下上述程序，会发现当输入字符串是下图中红叉叉部分所对应的时候，程序结果出错:
  </p>
  <p>
   <a href="../images/30%7E31/30.2.jpg" target="_blank">
    <img alt="" src="../images/30%7E31/30.2.jpg" style="max-width:100%;"/>
   </a>
  </p>
  <p>
   两个问题：
  </p>
  <p>
   1.当输入的字符串不是数字，而是字符的时候，比如“1a”，上述程序直接返回了0（而正确的结果应该是得到1）：
  </p>
  <div class="highlight highlight-cpp">
   <pre><span class="c1">// if the char is not a digit, invalid input  </span>
                  <span class="k">else</span>  
                  <span class="p">{</span>  
                      <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  
                      <span class="k">break</span><span class="p">;</span>  
                  <span class="p">}</span> 
</pre>
  </div>
  <p>
   2.处理溢出时，有问题。因为它遇到溢出情况时，直接返回了0：
  </p>
  <div class="highlight highlight-cpp">
   <pre><span class="c1">// overflow    </span>
                <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">())</span>  
                <span class="p">{</span>  
                    <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  
                    <span class="k">break</span><span class="p">;</span>  
                <span class="p">}</span>  
</pre>
  </div>
  <p>
   <em>
    <strong>
     4
    </strong>
   </em>
   . 把代码做下微调，如下（注：库函数atoi规定超过int值，按最大值maxint：2147483647来，超过-int按最小值minint：-2147483648来）：
  </p>
  <div class="highlight highlight-c">
   <pre><span class="c1">//copyright@SP_daiyq 2013/5/29</span>
<span class="kt">int</span> <span class="nf">StrToInt</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// result</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// index of str</span>
    <span class="kt">int</span> <span class="n">signal</span> <span class="o">=</span> <span class="sc">'+'</span><span class="p">;</span> <span class="c1">// signal '+' or '-'</span>
    <span class="kt">int</span> <span class="n">cur</span><span class="p">;</span> <span class="c1">// current digit</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">str</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// skip backspace</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>

    <span class="c1">// skip signal</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'+'</span> <span class="o">||</span> <span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// get result</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">'0'</span> <span class="o">&amp;&amp;</span> <span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">'9'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="sc">'0'</span><span class="p">;</span>

        <span class="c1">// judge overlap or not</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">signal</span> <span class="o">==</span> <span class="sc">'+'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span> <span class="o">-</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">signal</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cur</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span> <span class="o">-</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">INT_MIN</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">cur</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">signal</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">res</span> <span class="o">:</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</pre>
  </div>
  <p>
   此时会发现，上面第3小节末所述的第1个小问题（当输入的字符串不是数字，而是字符的时候）解决了：
  </p>
  <p>
   <a href="../images/30%7E31/30.3.jpg" target="_blank">
    <img alt="" src="../images/30%7E31/30.3.jpg" style="max-width:100%;"/>
   </a>
  </p>
  <p>
   但， 上文第3小节末所述的第2个小问题：溢出问题却没有解决。即当给定下述测试数据的时候，问题就来了：
  </p>
  <p>
   <a href="../images/30%7E31/30.4.jpg" target="_blank">
    <img alt="" src="../images/30%7E31/30.4.jpg" style="max-width:100%;"/>
   </a>
  </p>
  <p>
   什么问题呢？比如说用上述代码转换这个字符串："    10522545459"，它本应得到的正确结果应该是2147483647，但程序实际得到的结果却是：1932610867。故很明显，程序没有解决好上面的第2个小问题：溢出问题。原因是什么呢？咱们来分析下代码，看是如何具体处理溢出情况的：
  </p>
  <div class="highlight highlight-c">
   <pre><span class="c1">// judge overlap or not  </span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">signal</span> <span class="o">==</span> <span class="sc">'+'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span> <span class="o">-</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="p">)</span>  
        <span class="p">{</span>  
            <span class="n">res</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>  
            <span class="k">break</span><span class="p">;</span>  
        <span class="p">}</span>  
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">signal</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cur</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span> <span class="o">-</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="p">)</span>  
        <span class="p">{</span>  
            <span class="n">res</span> <span class="o">=</span> <span class="n">INT_MIN</span><span class="p">;</span>  
            <span class="k">break</span><span class="p">;</span>  
        <span class="p">}</span>  
</pre>
  </div>
  <p>
   接着上面的例子来，比如给定字符串"    10522545459"，除去空格有11位，而MAX_INT，即2147483647是10位数，当扫描到最后一个字符‘9’的时候，程序会比较 9 和 2147483647 - 1052254545*10的大小。
   <br/>
   问题立马就暴露出来了，因为此时让res*10，即让1052254545*10 &gt; MAX_INT，溢出无疑，程序已经出错，再执行下面这行代码已无意义：
  </p>
  <div class="highlight highlight-c">
   <pre>  <span class="n">cur</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span> <span class="o">-</span> <span class="n">res</span><span class="o">*</span><span class="mi">10</span>    
</pre>
  </div>
  <p>
   也就是说，对于字符串"10522545459", 当扫描到最后一个字符‘9’时，根据上文第1小节的字符串转换成整数的思路：“每扫描到一个字符，我们便把在之前得到的数字乘以10，然后再加上当前字符表示的数字”，为了得到最终的整数，我们得如此计算：
   <br/>
   1052254545*10 + 4，
   <br/>
   实际上当程序计算到1052254545*10时，
   <br/>
   1052254545*10 &gt; 2147483647
   <br/>
   此时已经溢出了,若再执意计算，则程序逻辑将出错，故此后也就不能再判断字串的最后一位4是否大于2147483647%10了（耐不得烦想尽快看到最终正确代码的读者可以直接跳到下文第8节）。
  </p>
  <p>
   <em>
    <strong>
     5
    </strong>
   </em>
   . 上面说给的程序没有“很好的解决溢出问题。由于输入的数字是以字符串的形式输入，因此有可能输入一个很大的数字转换之后会超过能够表示的最大的整数而溢出”。那么，到底代码该如何写呢？
  </p>
  <p>
   像下面这样？：
  </p>
  <div class="highlight highlight-c">
   <pre><span class="c1">//copyright@fuwutu 2013/5/29</span>
<span class="kt">int</span> <span class="nf">StrToInt</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">bool</span> <span class="n">negative</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">' '</span> <span class="o">||</span> <span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">'\t'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">++</span><span class="n">str</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">negative</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="o">++</span><span class="n">str</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">'+'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">++</span><span class="n">str</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="o">*</span><span class="n">str</span> <span class="o">-</span> <span class="sc">'0'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">negative</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">-</span> <span class="n">n</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">2147483648LL</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2147483648LL</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="mi">2147483647LL</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">result</span> <span class="o">=</span> <span class="mi">2147483647LL</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="o">++</span><span class="n">str</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre>
  </div>
  <p>
   run下程序，看看运行结果：
  </p>
  <p>
   <a href="../images/30%7E31/30.5.jpg" target="_blank">
    <img alt="" src="../images/30%7E31/30.5.jpg" style="max-width:100%;"/>
   </a>
  </p>
  <p>
   上图所示程序貌似通过了，然实际上它还是未能处理数据溢出的问题，因为它只是做了个取巧，即把返回的值result定义成了long long，如下所示：
  </p>
  <div class="highlight highlight-c">
   <pre>  <span class="kt">long</span> <span class="kt">long</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  
</pre>
  </div>
  <p>
   故严格说来，我们依然未写出准确的规范代码
  </p>
  <p>
   <em>
    <strong>
     6
    </strong>
   </em>
   . 咱们接下来便看看linux内核中是如何实现此字符串转换为整数的问题的。linux内核中提供了以下几个函数：
  </p>
  <ol>
   <li>
    simple_strtol，把一个字符串转换为一个有符号长整数；
    <br/>
   </li>
   <li>
    simple_strtoll，把一个字符串转换为一个有符号长长整数；
    <br/>
   </li>
   <li>
    simple_strtoul，把一个字符串转换为一个无符号长整数；
    <br/>
   </li>
   <li>
    simple_strtoull，把一个字符串转换为一个无符号长长整数
    <br/>
   </li>
  </ol>
  <p>
   相关源码及分析如下。
   <br/>
   首先，atoi调下面的strtol：
  </p>
  <div class="highlight highlight-c">
   <pre><span class="c1">//linux/lib/vsprintf.c  </span>
<span class="c1">//Copyright (C) 1991, 1992  Linus Torvalds  </span>
<span class="c1">//simple_strtol - convert a string to a signed long  </span>
<span class="kt">long</span> <span class="nf">simple_strtol</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">endp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>  
        <span class="k">return</span> <span class="o">-</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">endp</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>  

    <span class="k">return</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">endp</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>  
<span class="p">}</span>  
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">simple_strtol</span><span class="p">);</span>  
</pre>
  </div>
  <p>
   然后，上面的strtol调下面的strtoul：
  </p>
  <div class="highlight highlight-c">
   <pre><span class="c1">//simple_strtoul - convert a string to an unsigned long  </span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">simple_strtoul</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">endp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="k">return</span> <span class="n">simple_strtoull</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">endp</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>  
<span class="p">}</span>  
</pre>
  </div>
  <p>
   接着，上面的strtoul调下面的strtoull：
  </p>
  <div class="highlight highlight-c">
   <pre><span class="c1">//simple_strtoll - convert a string to a signed long long  </span>
<span class="kt">long</span> <span class="kt">long</span> <span class="nf">simple_strtoll</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">endp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>  
        <span class="k">return</span> <span class="o">-</span><span class="n">simple_strtoull</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">endp</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>  

    <span class="k">return</span> <span class="n">simple_strtoull</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">endp</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>  
<span class="p">}</span>  
</pre>
  </div>
  <p>
   最后，strtoull调
   <code>
    _parse_integer_fixup_radix
   </code>
   和
   <code>
    _parse_integer
   </code>
   来处理相关逻辑：
  </p>
  <div class="highlight highlight-c">
   <pre><span class="c1">//simple_strtoull - convert a string to an unsigned long long  </span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">simple_strtoull</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">endp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">result</span><span class="p">;</span>  
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>  

    <span class="n">cp</span> <span class="o">=</span> <span class="n">_parse_integer_fixup_radix</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base</span><span class="p">);</span>  
    <span class="n">rv</span> <span class="o">=</span> <span class="n">_parse_integer</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>  
    <span class="cm">/* FIXME */</span>  
    <span class="n">cp</span> <span class="o">+=</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">KSTRTOX_OVERFLOW</span><span class="p">);</span>  

    <span class="k">if</span> <span class="p">(</span><span class="n">endp</span><span class="p">)</span>  
        <span class="o">*</span><span class="n">endp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cp</span><span class="p">;</span>  

    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>  
<span class="p">}</span>  
</pre>
  </div>
  <p>
   重头戏来了。接下来，我们来看上面strtoull函数中的
   <code>
    parse_integer_fixup_radix
   </code>
   和
   <code>
    _parse_integer
   </code>
   两段代码。如鲨鱼所说
  </p>
  <ul>
   <li>
    “真正的处理逻辑主要是在
    <code>
     _parse_integer
    </code>
    里面，关于溢出的处理，
    <code>
     _parse_integer
    </code>
    处理的很优美，
    <br/>
   </li>
   <li>
    而
    <code>
     _parse_integer_fixup_radix
    </code>
    是用来自动根据字符串判断进制的”。
    <br/>
   </li>
  </ul>
  <p>
   先来看
   <code>
    _parse_integer
   </code>
   函数：
  </p>
  <div class="highlight highlight-c">
   <pre><span class="c1">//lib/kstrtox.c, line 39    </span>
<span class="c1">//Convert non-negative integer string representation in explicitly given radix to an integer.    </span>
<span class="c1">//Return number of characters consumed maybe or-ed with overflow bit.    </span>
<span class="c1">//If overflow occurs, result integer (incorrect) is still returned.    </span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">_parse_integer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>    
<span class="p">{</span>    
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">res</span><span class="p">;</span>    
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>    
    <span class="kt">int</span> <span class="n">overflow</span><span class="p">;</span>    

    <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    
    <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    
    <span class="n">overflow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    
    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>    
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>    

        <span class="k">if</span> <span class="p">(</span><span class="sc">'0'</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="n">s</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">s</span> <span class="o">&lt;=</span> <span class="sc">'9'</span><span class="p">)</span>    
            <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span> <span class="o">-</span> <span class="sc">'0'</span><span class="p">;</span>    
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="sc">'a'</span> <span class="o">&lt;=</span> <span class="n">_tolower</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">_tolower</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="sc">'f'</span><span class="p">)</span>    
            <span class="n">val</span> <span class="o">=</span> <span class="n">_tolower</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="sc">'a'</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>    
        <span class="k">else</span>    
            <span class="k">break</span><span class="p">;</span>    

        <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">base</span><span class="p">)</span>    
            <span class="k">break</span><span class="p">;</span>    
        <span class="cm">/*  </span>
<span class="cm">         * Check for overflow only if we are within range of  </span>
<span class="cm">         * it in the max base we support (16)  </span>
<span class="cm">         */</span>    
        <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">res</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mi">0ull</span> <span class="o">&lt;&lt;</span> <span class="mi">60</span><span class="p">)))</span> <span class="p">{</span>    
            <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="n">div_u64</span><span class="p">(</span><span class="n">ULLONG_MAX</span> <span class="o">-</span> <span class="n">val</span><span class="p">,</span> <span class="n">base</span><span class="p">))</span>    
                <span class="n">overflow</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>    
        <span class="p">}</span>    
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">*</span> <span class="n">base</span> <span class="o">+</span> <span class="n">val</span><span class="p">;</span>    
        <span class="n">rv</span><span class="o">++</span><span class="p">;</span>    
        <span class="n">s</span><span class="o">++</span><span class="p">;</span>    
    <span class="p">}</span>    
    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>    
    <span class="k">if</span> <span class="p">(</span><span class="n">overflow</span><span class="p">)</span>    
        <span class="n">rv</span> <span class="o">|=</span> <span class="n">KSTRTOX_OVERFLOW</span><span class="p">;</span>    
    <span class="k">return</span> <span class="n">rv</span><span class="p">;</span>    
<span class="p">}</span>  
</pre>
  </div>
  <p>
   解释下两个小细节：
  </p>
  <p>
   1.上头出现了个unlikely，其实unlikely和likely经常出现在linux相关内核源码中
  </p>
  <div class="highlight highlight-c">
   <pre><span class="k">if</span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">value</span><span class="p">)){</span>  
    <span class="c1">//等价于if(likely(value)) == if(value)  </span>
<span class="p">}</span>  
<span class="k">else</span><span class="p">{</span>  
<span class="p">}</span>  
</pre>
  </div>
  <p>
   likely表示value为真的可能性更大，而unlikely表示value为假的可能性更大，这两个宏被定义成：
  </p>
  <div class="highlight highlight-c">
   <pre><span class="c1">//include/linux/compiler.h  </span>
<span class="cp"># ifndef likely  </span>
<span class="cp">#  define likely(x) (__builtin_constant_p(x) ? !!(x) : __branch_check__(x, 1))  </span>
<span class="cp"># endif  </span>
<span class="cp"># ifndef unlikely  </span>
<span class="cp">#  define unlikely(x)   (__builtin_constant_p(x) ? !!(x) : __branch_check__(x, 0))  </span>
<span class="cp"># endif  </span>
</pre>
  </div>
  <p>
   2.呈现下div_u64的代码：
  </p>
  <div class="highlight highlight-c">
   <pre><span class="c1">//include/linux/math64.h  </span>
<span class="c1">//div_u64  </span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">div_u64</span><span class="p">(</span><span class="n">u64</span> <span class="n">dividend</span><span class="p">,</span> <span class="n">u32</span> <span class="n">divisor</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="n">u32</span> <span class="n">remainder</span><span class="p">;</span>  
    <span class="k">return</span> <span class="n">div_u64_rem</span><span class="p">(</span><span class="n">dividend</span><span class="p">,</span> <span class="n">divisor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">remainder</span><span class="p">);</span>  
<span class="p">}</span>  

<span class="c1">//div_u64_rem  </span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">div_u64_rem</span><span class="p">(</span><span class="n">u64</span> <span class="n">dividend</span><span class="p">,</span> <span class="n">u32</span> <span class="n">divisor</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">remainder</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="o">*</span><span class="n">remainder</span> <span class="o">=</span> <span class="n">dividend</span> <span class="o">%</span> <span class="n">divisor</span><span class="p">;</span>  
    <span class="k">return</span> <span class="n">dividend</span> <span class="o">/</span> <span class="n">divisor</span><span class="p">;</span>  
<span class="p">}</span> 
</pre>
  </div>
  <p>
   最后看下
   <code>
    _parse_integer_fixup_radix
   </code>
   函数：
  </p>
  <div class="highlight highlight-c">
   <pre><span class="c1">//lib/kstrtox.c, line 23  </span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">_parse_integer_fixup_radix</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">base</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>  
        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'0'</span><span class="p">)</span> <span class="p">{</span>  
            <span class="k">if</span> <span class="p">(</span><span class="n">_tolower</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="sc">'x'</span> <span class="o">&amp;&amp;</span> <span class="n">isxdigit</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>  
                <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>  
            <span class="k">else</span>  
                <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>  
        <span class="p">}</span> <span class="k">else</span>  
            <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>  
    <span class="p">}</span>  
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">base</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'0'</span> <span class="o">&amp;&amp;</span> <span class="n">_tolower</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="sc">'x'</span><span class="p">)</span>  
        <span class="n">s</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>  
    <span class="k">return</span> <span class="n">s</span><span class="p">;</span>  
<span class="p">}</span>  
</pre>
  </div>
  <p>
   读者MJN君在我的建议下，对上述linux内核中的atoi函数进行了测试，咱们来看下测试结果如何。
  </p>
  <p>
   <a href="../images/30%7E31/30.6.jpg" target="_blank">
    <img alt="" src="../images/30%7E31/30.6.jpg" style="max-width:100%;"/>
   </a>
  </p>
  <p>
   如上，根据程序的输出结果可以看出，对于某些溢出的情况，atoi程序的处理并不符合本题的要求。
   <br/>
   也就是说，atoi程序对溢出的处理是一个标准，而本题要求对溢出的处理则是另外一个标准，所以说直接用atoi程序达不到本题的要求，但你不能因为本题的标准而否认atoi程序的正确性。
   <br/>
   既然直接借用atoi的源码（原理是parseXXX，
   <code>
    int i=Integer.parseInt(String str)
   </code>
   ，把str转换成int的方法），不符合题目要求，则咱们另寻他路。
   <br/>
   路漫漫其修远兮，吾等将上下而求索，但与此同时，我们已渐入佳境。
  </p>
  <p>
   <em>
    <strong>
     7
    </strong>
   </em>
   . 根据我们第1小节达成一致的字符串转换成整数的思路：“每扫描到一个字符，我们便把在之前得到的数字乘以10，然后再加上当前字符表示的数字”，相信读者已经觉察到，在扫描到最后一个字符的时候，如果之前得到的数比较大，此时若再让其扩大10倍，相对来说是比较容易溢出的。
  </p>
  <p>
   但车到山前必有路，既然让一个比较大的int整型数括大10倍，比较容易溢出， 那么在不好判断是否溢出的情况下，可以尝试使用除法。即如MJN所说：
  </p>
  <ol>
   <li>
    与其将n扩大10倍,，冒着溢出的风险, 再与MAX_INT进行比较（如果已经溢出, 则比较的结果没有意义），
    <br/>
   </li>
   <li>
    不如未雨绸缪先用n与MAX_INT/10进行比较： 若n&gt;MAX_INT/10（当然同时还要考虑n=MAX_INT/10的情况）， 说明最终得到的整数一定会溢出， 故此时可以当即进行溢出处理，直接返回最大值MAX_INT，从而也就免去了计算n*10这一步骤。
    <br/>
   </li>
  </ol>
  <p>
   也就是说，计算n*10前,先比较n与MAX_INT/10大小，若n&gt;MAX_INT/10，那么n*10肯定大于MAX_INT，即代表最后得到的整数n肯定溢出，既然溢出，不能再计算n*10，直接提前返回MAX_INT就行了。
  </p>
  <p>
   一直以来，我们努力的目的归根结底是为了更好的处理溢出，但上述做法最重要的是巧妙的规避了计算n*10这一乘法步骤，转换成计算除法MAX_INT/10代替，不能不说此法颇妙。
  </p>
  <p>
   他的代码如下，如有问题请指出：
  </p>
  <div class="highlight highlight-c">
   <pre><span class="c1">//copyright@njnu_mjn 2013</span>
<span class="kt">int</span> <span class="nf">StrToDecInt</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">MAX</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="kt">unsigned</span><span class="p">)</span><span class="o">~</span><span class="mi">0</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">MIN</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="kt">unsigned</span><span class="p">)</span><span class="o">~</span><span class="mi">0</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">))</span>
        <span class="o">++</span><span class="n">str</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">'+'</span> <span class="o">||</span> <span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="o">++</span><span class="n">str</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">str</span> <span class="o">-</span> <span class="sc">'0'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sign</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">MAX</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">||</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">MAX</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">MAX</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)))</span>
        <span class="p">{</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sign</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">MIN</span> <span class="o">/</span> <span class="mi">10</span>
                  <span class="o">||</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">MIN</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">MIN</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)))</span>
        <span class="p">{</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">MIN</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">c</span><span class="p">;</span>
        <span class="o">++</span><span class="n">str</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">sign</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">n</span> <span class="o">:</span> <span class="o">-</span><span class="n">n</span><span class="p">;</span>
<span class="p">}</span>
</pre>
  </div>
  <p>
   上述代码从测试结果来看，暂未发现什么问题
  </p>
  <p>
   <a href="../images/30%7E31/30.7.jpg" target="_blank">
    <img alt="" src="../images/30%7E31/30.7.jpg" style="max-width:100%;"/>
   </a>
  </p>
  <p>
   咱们再来总结下上述代码是如何处理溢出情况的。对于正数来说，它溢出的可能性有两种：
  </p>
  <ol>
   <li>
    一种是诸如2147483650，即n &gt; MAX/10 的；
    <br/>
   </li>
   <li>
    一种是诸如2147483649，即n == MAX/10 &amp;&amp; c &gt; MAX%10。
    <br/>
    故咱们上面处理溢出情况的代码便是：
    <br/>
   </li>
  </ol>
  <div class="highlight highlight-c">
   <pre><span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">str</span> <span class="o">-</span> <span class="sc">'0'</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">sign</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">MAX</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">||</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">MAX</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">MAX</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)))</span>
<span class="p">{</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sign</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">MIN</span> <span class="o">/</span> <span class="mi">10</span>
          <span class="o">||</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">MIN</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">MIN</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)))</span>
<span class="p">{</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">MIN</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</pre>
  </div>
  <p>
   不过，即便如此，有些细节是改进的，如他自己所说：
  </p>
  <p>
   1.n的声明及定义应该为
  </p>
  <div class="highlight highlight-c">
   <pre><span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
</pre>
  </div>
  <p>
   2.将MAX/10,MAX%10,(unsigned)MIN/10及(unsigned)MIN%10保存到变量中, 防止重复计算
  </p>
  <p>
   这样，优化后的代码为：
  </p>
  <div class="highlight highlight-c">
   <pre><span class="c1">//copyright@njnu_mjn 2013</span>
<span class="kt">int</span> <span class="nf">StrToDecInt</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">MAX</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="kt">unsigned</span><span class="p">)</span><span class="o">~</span><span class="mi">0</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">MIN</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="kt">unsigned</span><span class="p">)</span><span class="o">~</span><span class="mi">0</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">MAX_DIV</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="kt">unsigned</span><span class="p">)</span><span class="o">~</span><span class="mi">0</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">MIN_DIV</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((((</span><span class="kt">unsigned</span><span class="p">)</span><span class="o">~</span><span class="mi">0</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">MAX_R</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="kt">unsigned</span><span class="p">)</span><span class="o">~</span><span class="mi">0</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">MIN_R</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((((</span><span class="kt">unsigned</span><span class="p">)</span><span class="o">~</span><span class="mi">0</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">))</span>
        <span class="o">++</span><span class="n">str</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">'+'</span> <span class="o">||</span> <span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="o">++</span><span class="n">str</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">str</span> <span class="o">-</span> <span class="sc">'0'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sign</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">MAX_DIV</span> <span class="o">||</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">MAX_DIV</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="n">MAX_R</span><span class="p">)))</span>
        <span class="p">{</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sign</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">MIN_DIV</span>
                  <span class="o">||</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">MIN_DIV</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="n">MIN_R</span><span class="p">)))</span>
        <span class="p">{</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">MIN</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">c</span><span class="p">;</span>
        <span class="o">++</span><span class="n">str</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">sign</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">n</span> <span class="o">:</span> <span class="o">-</span><span class="n">n</span><span class="p">;</span>
<span class="p">}</span>
</pre>
  </div>
  <p>
   部分数据的测试结果如下图所示：
  </p>
  <p>
   <a href="../images/30%7E31/30.8.jpg" target="_blank">
    <img alt="" src="../images/30%7E31/30.8.jpg" style="max-width:100%;"/>
   </a>
  </p>
  <p>
   是否已是完美？如MJN君本人所说“我的实现与linux内核的atoi函数的实现, 都有一个共同的问题: 即使出错, 函数也返回了一个值, 导致调用者误认为自己传入的参数是正确的, 但是可能会导致程序的其他部分产生莫名的错误且很难调试”。
  </p>
  <p>
   <em>
    <strong>
     8
    </strong>
   </em>
   . 最后看下Nut/OS中atoi的实现，同时，本小节内容主要来自参考文献条目9，即MJN的博客：
  </p>
  <div class="highlight highlight-c">
   <pre><span class="cp">#include &lt;compiler.h&gt;  </span>
<span class="cp">#include &lt;stdlib.h&gt;  </span>

<span class="kt">int</span> <span class="nf">atoi</span><span class="p">(</span><span class="n">CONST</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="k">return</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">strtol</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">));</span>  
<span class="p">}</span>  
</pre>
  </div>
  <p>
   上述代码中strtol实现的思想跟上文第7节所述的MJN君的思路类似，也是除法代替乘法。加上测试函数后的具体代码如下：
  </p>
  <div class="highlight highlight-c">
   <pre><span class="cp">#include &lt;errno.h&gt;  </span>
<span class="cp">#include &lt;stdio.h&gt;  </span>
<span class="cp">#include &lt;ctype.h&gt;  </span>
<span class="cp">#include &lt;limits.h&gt;  </span>

<span class="cp">#define CONST const  </span>

<span class="kt">long</span> <span class="nf">mstrtol</span><span class="p">(</span><span class="n">CONST</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nptr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">endptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">base</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="k">register</span> <span class="n">CONST</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>  
    <span class="k">register</span> <span class="kt">long</span> <span class="n">acc</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">;</span>  
    <span class="k">register</span> <span class="kt">int</span> <span class="n">c</span><span class="p">;</span>  
    <span class="k">register</span> <span class="kt">int</span> <span class="n">neg</span><span class="p">,</span> <span class="n">any</span><span class="p">,</span> <span class="n">cutlim</span><span class="p">;</span>  

    <span class="cm">/* </span>
<span class="cm">     * Skip white space and pick up leading +/- sign if any. </span>
<span class="cm">     * If base is 0, allow 0x for hex and 0 for octal, else </span>
<span class="cm">     * assume decimal; if base is already 16, allow 0x. </span>
<span class="cm">     */</span>  
    <span class="n">s</span> <span class="o">=</span> <span class="n">nptr</span><span class="p">;</span>  
    <span class="k">do</span>
    <span class="p">{</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="o">*</span><span class="n">s</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">neg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">neg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'+'</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">base</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">base</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'0'</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">'x'</span> <span class="o">||</span> <span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">'X'</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">base</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'0'</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">10</span><span class="p">;</span>

    <span class="cm">/* </span>
<span class="cm">     * Compute the cutoff value between legal numbers and illegal </span>
<span class="cm">     * numbers.  That is the largest legal value, divided by the </span>
<span class="cm">     * base.  An input number that is greater than this value, if </span>
<span class="cm">     * followed by a legal input character, is too big.  One that </span>
<span class="cm">     * is equal to this value may be valid or not; the limit </span>
<span class="cm">     * between valid and invalid numbers is then based on the last </span>
<span class="cm">     * digit.  For instance, if the range for longs is </span>
<span class="cm">     * [-2147483648..2147483647] and the input base is 10, </span>
<span class="cm">     * cutoff will be set to 214748364 and cutlim to either </span>
<span class="cm">     * 7 (neg==0) or 8 (neg==1), meaning that if we have accumulated </span>
<span class="cm">     * a value &gt; 214748364, or equal but the next digit is &gt; 7 (or 8), </span>
<span class="cm">     * the number is too big, and we will return a range error. </span>
<span class="cm">     * </span>
<span class="cm">     * Set any if any 'digits' consumed; make it negative to indicate </span>
<span class="cm">     * overflow. </span>
<span class="cm">     */</span>  
    <span class="n">cutoff</span> <span class="o">=</span> <span class="n">neg</span> <span class="o">?</span> <span class="n">LONG_MIN</span> <span class="o">:</span> <span class="n">LONG_MAX</span><span class="p">;</span>
    <span class="n">cutlim</span> <span class="o">=</span> <span class="n">cutoff</span> <span class="o">%</span> <span class="n">base</span><span class="p">;</span>
    <span class="n">cutoff</span> <span class="o">/=</span> <span class="n">base</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">neg</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cutlim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
            <span class="n">cutlim</span> <span class="o">-=</span> <span class="n">base</span><span class="p">;</span>
            <span class="n">cutoff</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">cutlim</span> <span class="o">=</span> <span class="o">-</span><span class="n">cutlim</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">acc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">any</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="o">*</span><span class="n">s</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="n">c</span> <span class="o">-=</span> <span class="sc">'0'</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isalpha</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="n">c</span> <span class="o">-=</span> <span class="n">isupper</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">?</span> <span class="sc">'A'</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">:</span> <span class="sc">'a'</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="n">base</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">any</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">neg</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">acc</span> <span class="o">&lt;</span> <span class="n">cutoff</span> <span class="o">||</span> <span class="n">acc</span> <span class="o">==</span> <span class="n">cutoff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">cutlim</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">any</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="n">acc</span> <span class="o">=</span> <span class="n">LONG_MIN</span><span class="p">;</span>
                <span class="n">errno</span> <span class="o">=</span> <span class="n">ERANGE</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">any</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">acc</span> <span class="o">*=</span> <span class="n">base</span><span class="p">;</span>
                <span class="n">acc</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">acc</span> <span class="o">&gt;</span> <span class="n">cutoff</span> <span class="o">||</span> <span class="n">acc</span> <span class="o">==</span> <span class="n">cutoff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">cutlim</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">any</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="n">acc</span> <span class="o">=</span> <span class="n">LONG_MAX</span><span class="p">;</span>
                <span class="n">errno</span> <span class="o">=</span> <span class="n">ERANGE</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">any</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">acc</span> <span class="o">*=</span> <span class="n">base</span><span class="p">;</span>
                <span class="n">acc</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">endptr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="o">*</span><span class="n">endptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">any</span> <span class="o">?</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">nptr</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">acc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">matoi2</span><span class="p">(</span><span class="n">CONST</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="k">return</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">mstrtol</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">));</span>  
<span class="p">}</span>  

<span class="kt">int</span> <span class="nf">mgetline</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">())</span> <span class="o">!=</span> <span class="n">EOF</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">'\n'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">buf</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">buf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>  

<span class="cp">#define MAX_LINE 200  </span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAX_LINE</span><span class="p">];</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">mgetline</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">MAX_LINE</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"quit"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"matoi2=%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">matoi2</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre>
  </div>
  <p>
   同样，MJN对上述实现测试了下，结果如下:
  </p>
  <p>
   <a href="../images/30%7E31/30.9.jpg" target="_blank">
    <img alt="" src="../images/30%7E31/30.9.jpg" style="max-width:100%;"/>
   </a>
  </p>
  <p>
   程序貌似对溢出的处理是正确的, 真的吗? 再把测试数据换成"10522545454"（与"10522545459"的区别在于最后一个字符）
  </p>
  <p>
   <a href="../images/30%7E31/30.10.jpg" target="_blank">
    <img alt="" src="../images/30%7E31/30.10.jpg" style="max-width:100%;"/>
   </a>
  </p>
  <p>
   症结就在于下面这段代码：
  </p>
  <div class="highlight highlight-c">
   <pre><span class="k">if</span> <span class="p">(</span><span class="n">neg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">acc</span> <span class="o">&lt;</span> <span class="n">cutoff</span> <span class="o">||</span> <span class="n">acc</span> <span class="o">==</span> <span class="n">cutoff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">cutlim</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">any</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">LONG_MIN</span><span class="p">;</span>
        <span class="n">errno</span> <span class="o">=</span> <span class="n">ERANGE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">any</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">acc</span> <span class="o">*=</span> <span class="n">base</span><span class="p">;</span>
        <span class="n">acc</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">acc</span> <span class="o">&gt;</span> <span class="n">cutoff</span> <span class="o">||</span> <span class="n">acc</span> <span class="o">==</span> <span class="n">cutoff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">cutlim</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">any</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">LONG_MAX</span><span class="p">;</span>
        <span class="n">errno</span> <span class="o">=</span> <span class="n">ERANGE</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
  </div>
  <p>
   要想得到正确的输出结果，需要改动两个地方：
  </p>
  <p>
   1.其中这行：
  </p>
  <div class="highlight highlight-c">
   <pre>  <span class="k">if</span> <span class="p">((</span><span class="n">acc</span> <span class="o">&gt;</span> <span class="n">cutoff</span> <span class="o">||</span> <span class="n">acc</span> <span class="o">==</span> <span class="n">cutoff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">cutlim</span><span class="p">)</span>    
</pre>
  </div>
  <p>
   应该改为：
  </p>
  <div class="highlight highlight-c">
   <pre>  <span class="k">if</span> <span class="p">(</span> <span class="n">acc</span> <span class="o">&gt;</span> <span class="n">cutoff</span> <span class="o">||</span>  <span class="p">(</span><span class="n">acc</span> <span class="o">==</span> <span class="n">cutoff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">cutlim</span><span class="p">)</span>  <span class="p">)</span>    
</pre>
  </div>
  <p>
   2.与此同时，这行:
  </p>
  <div class="highlight highlight-c">
   <pre>  <span class="k">if</span> <span class="p">((</span><span class="n">acc</span> <span class="o">&lt;</span> <span class="n">cutoff</span> <span class="o">||</span> <span class="n">acc</span> <span class="o">==</span> <span class="n">cutoff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">cutlim</span><span class="p">)</span> <span class="p">{</span>    
</pre>
  </div>
  <p>
   改为
  </p>
  <div class="highlight highlight-c">
   <pre>  <span class="k">if</span> <span class="p">(</span><span class="n">acc</span> <span class="o">&lt;</span> <span class="n">cutoff</span> <span class="o">||</span> <span class="p">(</span><span class="n">acc</span> <span class="o">==</span> <span class="n">cutoff</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">cutlim</span><span class="p">))</span> <span class="p">{</span>    
</pre>
  </div>
  <p>
   为何要这样修改呢？细心的读者相信还是会记得上文第8节中关于正数的两种溢出情况的可能性：“对于正数来说，它溢出的可能性有两种：
  </p>
  <ol>
   <li>
    一种是诸如2147483650，即n &gt; MAX/10 的；
    <br/>
   </li>
   <li>
    一种是诸如2147483649，即n == MAX/10 &amp;&amp; c &gt; MAX%10。
   </li>
  </ol>
  <p>
   也就是说无论是"10522545459"，还是"10522545454"，都是属于第1种情况，即“诸如2147483650，即n &gt; MAX/10的”，此时直接返回MAX_INT即可，所以不需要也不能再去判断n == MAX/10的情况。
这个处理思路类似于上文第8节处理溢出情况的代码：
  </p>
  <div class="highlight highlight-c">
   <pre><span class="k">if</span> <span class="p">(</span><span class="n">sign</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">MAX</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">||</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">MAX</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">MAX</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)))</span>
<span class="p">{</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sign</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">MIN</span> <span class="o">/</span> <span class="mi">10</span>
          <span class="o">||</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">MIN</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">MIN</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)))</span>
<span class="p">{</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">MIN</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</pre>
  </div>
  <p>
   So，修改过后的代码测试正常:
  </p>
  <p>
   <a href="../images/30%7E31/30.11.jpg" target="_blank">
    <img alt="" src="../images/30%7E31/30.11.jpg" style="max-width:100%;"/>
   </a>
  </p>
  <p>
   OK，字符串转换成整数这一问题已基本解决。但如果面试官继续问你，如何把整数转换成字符串呢？欢迎于本文评论下或hero上show出你的思路或代码。
  </p>
  <h2>
   <a class="anchor" href="#%E7%B1%BB%E4%BC%BC%E9%97%AE%E9%A2%98" name="user-content-%E7%B1%BB%E4%BC%BC%E9%97%AE%E9%A2%98">
    <span class="octicon octicon-link">
    </span>
   </a>
   类似问题
  </h2>
  <ol>
   <li>
    实现string到double的转换
   </li>
  </ol>
  <p>
   提醒：此题虽然类似于atoi函数，但毕竟double为64位，而且支持小数，因而边界条件更加严格，写代码时需要更加注意。
  </p>
 </body>
</html>
		  </article>
		  
			<div id="nav">
				
					<a href="06.09.html">prev</a>
					|
				
				
					<a href="06.11.html">next</a>
				
				<span style="float: right"><a href="index.html">Back to home</a>
			</div>
		  
		</div>
	</div>
  </div>
  
  <div>&nbsp;</div>
  </div>
  <div style="text-align:center; margin-bottom: 30px">
	  Generated by <a href="https://github.com/marchtea/md_to_github_html">mdtogh</a>
  </div>
</body>
</html>